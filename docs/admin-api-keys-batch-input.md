# Admin / API Keys 批量录入（悬浮卡片输入）设计

## 背景

`/admin` 页面中，API Keys 面板头部提供了一组「单行输入 + 添加按钮」的控件，用于新增一条 Tavily
API key。当前形态不利于一次性粘贴多条 key（批量导入/迁移/补录场景）。

本工作将该区域升级为「批量录入」体验：在 hover / focus 时展开为不影响布局的悬浮卡片（overlay），
支持多行输入、按行批量提交、提交后弹窗汇报并清空输入。

## 目标

- 在不影响其它界面元素布局的前提下，将「新增 API key」升级为「批量导入（每行一个 key）」。
- 交互自然：hover/focus 展开，点击外部或按 `Esc` 收起；提交完成后自动收起。
- 支持部分成功：与 DB 去重（已存在跳过、软删恢复），并在弹窗中报告分类统计与失败明细（不掩码）。

## 非目标

- 不引入除「换行」以外的分隔符（不支持逗号/空格/分号等）。
- 不调整 API Keys 表格与其它面板布局（除 overlay 所需的最小层级处理）。
- 不在本次设计中覆盖其它 key 管理能力（禁用/删除/复制等保持现状）。

## 范围

### 影响范围（预期改动点）

- 前端：`web/src/AdminDashboard.tsx` 的 API Keys 面板头部输入区域（现为 `input + button`）。
- 前端 API：`web/src/api.ts` 增加批量新增 API keys 的请求函数。
- 后端：新增一个批量新增/恢复接口，复用现有的 “add or undelete” 语义。

### 不影响范围

- 既有单条新增接口 `POST /api/keys` 保持兼容（可继续被其它调用方使用）。

## 用户流程（关键用例）

1. 管理员进入 `/admin`。
2. 将鼠标移动到「新增 API key」区域，或通过键盘 Tab 聚焦到该区域任一元素。
3. 区域展开为悬浮卡片，显示多行输入框（textarea）与提交按钮。
4. 用户粘贴多行 key（每行一个），点击“添加密钥”提交。
5. 请求完成后弹窗汇报：新增/恢复/已存在跳过/输入重复跳过/失败 等统计；失败项列出原始 key 与原因。
6. 弹窗出现后清空输入并收起回折叠态。

收起行为：

- 点击卡片外部 → 收起（不提交）。
- `Esc` → 收起（不提交）。

## 交互与 UI 设计

### 位置与锚点

- 锚点：API Keys 面板头部右侧的新增控件组（折叠态仍占用原位置）。
- 展开态：以锚点为定位基础呈现 overlay 卡片（不进入文档流，不推动其它元素）。

### 状态机

#### 折叠态（默认）

- 显示：单行输入（现状）+ “添加密钥”按钮。
- 可用性：保持当前最小宽度与视觉风格。

#### 展开态（悬浮卡片）

- 内容：
  - textarea（提示：每行一个 key，仅支持换行）
  - “添加密钥”按钮（主按钮）
  - 可选：简短的 helper 文案（不影响布局）
- 触发条件：
  - 鼠标进入折叠控件组区域；或
  - 控件组内任一元素获得焦点。
- 关闭条件：
  - 点击卡片外部；或
  - 按 `Esc`；或
  - 提交完成并弹窗汇报后自动收起。
- 关闭约束：
  - 卡片内部交互（滚动/选中文本/点击按钮）不得触发关闭。

### 响应式尺寸（指导原则）

目标是“约当前两倍左右且适应多种屏幕宽度”。建议采用以下规则描述为实现约束：

- 折叠态输入区域保持现状（例如 `minWidth: 240px`）。
- 展开态卡片宽度建议：
  - 目标宽度：约 `2 * 折叠态宽度`（基准约 480px）；
  - 上限：不超过 `min(720px, viewportWidth - 2 * 16px)`；
  - 下限：不小于 `min(360px, viewportWidth - 2 * 16px)`；
  - 小屏下贴边显示，确保无横向溢出。
- 展开态高度建议至少 4 行可视，内容多时 textarea 内部滚动。

### 弹窗汇报（完成态）

- 触发：批量提交的请求结束（无论全成功/部分成功/全失败）。
- 内容：
  - 统计（必需）：
    - 输入行数（含空行）
    - 有效行数（trim + 去空行后）
    - 输入去重后条目数
    - 新增（created）
    - 恢复（undeleted）
    - DB 已存在跳过（existed）
    - 输入重复跳过（duplicate_in_input）
    - 失败（failed）
  - 失败明细（必需）：列出 `api_key`（不掩码）与 `error`。
- 行为：
  - 弹窗出现后，清空 textarea 内容，并将新增卡片收起至折叠态。

## 批量处理规则

### 输入解析

- 仅支持换行分割（`\n` / `\r\n`）。
- 对每行执行 `trim()`。
- 忽略空行。

### 去重与状态语义

按以下顺序处理：

1. 输入内去重：同一 `api_key` 多次出现只处理一次（其余计入 `duplicate_in_input`）。
2. 与 DB 去重：
   - 若 key 已存在且未软删：不新增，计入 `existed`。
   - 若 key 已存在但已软删：执行恢复（undelete），计入 `undeleted`。
   - 若 key 不存在：新增，计入 `created`。

### 部分成功

- 单条失败不应阻断其它条目处理。
- 失败条目需返回明确原因（例如：invalid input、db error、unexpected error）。

## 接口设计

### 新增：批量新增/恢复 API Keys

- **Method/Path**：`POST /api/keys/batch`
- **权限**：管理员（与 `POST /api/keys` 一致）
- **Request body**
  - `api_keys: string[]`
  - 说明：前端已按换行解析、trim、去空行、输入内去重后提交；后端仍需做基础校验。
- **限制**
  - 建议上限：最多 1000 条（超过返回 `400`，并提示上限；避免静默丢弃）。

#### Response（200）

返回可用于弹窗报告的结构化结果：

- `summary`
  - `input_lines: number`
  - `valid_lines: number`
  - `unique_in_input: number`
  - `created: number`
  - `undeleted: number`
  - `existed: number`
  - `duplicate_in_input: number`
  - `failed: number`
- `results: Array<{ api_key: string; status: string; id?: string; error?: string }>`
  - `status` ∈ `created | undeleted | existed | duplicate_in_input | failed`
  - 失败项必须带 `error`

#### 错误响应

- `403`：非管理员
- `400`：请求体非法、条目数超过上限等
- `500`：后端异常（仍建议返回可读错误信息，便于弹窗展示全局失败原因）

### 兼容保留：单条新增 API Key

既有接口 `POST /api/keys` 保持不变（仍返回 `{ id }`），用于兼容历史调用与简化场景。

## 验收标准（Given / When / Then）

### UI 展开与收起

- Given `/admin` 页面加载完成，API Keys 面板处于折叠态\
  When 鼠标移入新增控件组\
  Then 展开为 overlay 悬浮卡片，且页面其它元素布局不变（无抖动）

- Given 折叠态\
  When 通过键盘 Tab 使输入/按钮获得焦点\
  Then 自动展开为悬浮卡片

- Given 展开态\
  When 点击卡片外部 或 按 `Esc`\
  Then 立即收起且不触发提交

### 批量解析与去重

- Given textarea 输入多行 key（含空行、前后空白、重复行）\
  When 点击“添加密钥”\
  Then 仅按换行拆分；trim；忽略空行；输入内去重；与 DB 去重（已存在跳过、软删恢复）

### 部分成功与弹窗汇报

- Given 输入同时包含可新增、可恢复、已存在、以及会失败的条目\
  When 提交完成\
  Then 弹窗展示分类统计；失败明细列出原始 key 与原因（不掩码）；随后清空输入并收起

### 全局错误

- Given 服务返回 403/500 或网络错误\
  When 提交结束\
  Then 弹窗提示全局失败原因；清空输入并收起

## 测试计划（实现阶段执行）

- 前端：手动回归 hover/focus 展开、外点/`Esc` 收起、提交后收起、不同视口宽度下无溢出。
- 后端：为 `/api/keys/batch` 增加覆盖新增/恢复/已存在/失败/超上限的测试用例（单测或集成测试）。
